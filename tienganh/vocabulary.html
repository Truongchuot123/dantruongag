<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary - Nguyễn Mai Đan Trường</title>
    <meta name="description" content="Chào bạn! Đây là không gian cá nhân của Đan Trường. Khám phá thôi nào!.">
    <meta property="og:description" content="Chào bạn! Đây là không gian cá nhân của Đan Trường. Khám phá thôi nào!.">
    <meta property="og:image" content="/hinhanh/logo web.png">
    <meta property="og:url" content="https://dantruongag.id.vn">
    <!-- Tailwind CSS for rapid UI development -->
    <script src="https://cdn.tailwindcss.com"></script>
 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 for beautiful pop-ups -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Custom Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Apply a transition to the background color for smooth dark mode switching */
        body, #topicNav {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Custom scrollbar for topic navigation */
        #topicNav::-webkit-scrollbar {
            height: 6px;
        }
        #topicNav::-webkit-scrollbar-track {
            background: transparent;
        }
        #topicNav::-webkit-scrollbar-thumb {
            background-color: #a78bfa; /* purple-400 */
            border-radius: 20px;
        }
        html.dark #topicNav::-webkit-scrollbar-thumb {
            background-color: #8b5cf6; /* purple-600 */
        }
        
        /* Animation for highlighting a card when scrolling to it */
        .highlight-scroll {
            animation: highlight-animation-dark 2s ease-out;
        }

        @keyframes highlight-animation-dark {
            0% { background-color: rgba(161, 98, 7, 0.6); transform: scale(1); } /* yellow-700 with opacity */
            20% { transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }
        
        /* Custom styles for Swal2 Form */
        .swal2-input, .swal2-textarea, .swal2-select {
            width: 100% !important;
            border-radius: 0.5rem !important;
            border-color: #d1d5db !important; /* gray-300 */
            color: #111827 !important; /* text-gray-900 mặc định cho light mode */
            background-color: #ffffff !important; /* trắng cho light mode */
        }

        html.dark .swal2-input,
        html.dark .swal2-textarea,
        html.dark .swal2-select {
            background-color: #374151 !important; /* gray-700 */
            border-color: #4b5563 !important; /* gray-600 */
            color: #ffffff !important; /* trắng cho dark mode */
        }

        .swal2-input::placeholder,
        .swal2-textarea::placeholder {
            color: #9ca3af !important; /* gray-400 cho placeholder */
        }

        html.dark .swal2-input::placeholder,
        html.dark .swal2-textarea::placeholder {
            color: #9ca3af !important; /* gray-400 trong dark mode cũng giữ placeholder nhạt */
        }

        .swal2-html-container {
            scrollbar-width: thin;
            scrollbar-color: #a78bfa #e5e7eb;
        }

        .swal2-html-container::-webkit-scrollbar {
            width: 8px;
        }

        .swal2-html-container::-webkit-scrollbar-track {
            background: #e5e7eb; /* gray-200 */
        }

        html.dark .swal2-html-container::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
        }

        .swal2-html-container::-webkit-scrollbar-thumb {
            background-color: #a78bfa; /* purple-400 */
            border-radius: 20px;
            border: 3px solid transparent;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 sm:p-6 lg:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-purple-400">Hệ thống học từ vựng</h1>
            <div class="flex items-center gap-2 sm:gap-4">
                <button onclick="goBack()" class="bg-gray-700 hover:bg-gray-600 font-bold py-2 px-4 rounded-lg transition-colors shadow-sm border border-gray-600">
                    &larr; Quay về
                </button>
                <button id="add-word-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                    + Thêm từ
                </button>
            </div>
        </header>

        <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="search" placeholder="Tìm kiếm từ vựng..." class="w-full p-3 bg-gray-800 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-purple-400 transition-colors">
            <div class="flex items-center justify-center space-x-1 bg-gray-800 p-1 rounded-lg">
                <button onclick="setFilter('all', this)" class="filter-btn active w-full py-2 px-4 rounded-md font-semibold transition-all">Tất cả</button>
                <button onclick="setFilter('checked', this)" class="filter-btn w-full py-2 px-4 rounded-md font-semibold transition-all">Đã học</button>
                <button onclick="setFilter('unchecked', this)" class="filter-btn w-full py-2 px-4 rounded-md font-semibold transition-all">Chưa học</button>
            </div>
        </div>
        
        <div id="stats" class="text-center text-gray-400 font-semibold mb-4"></div>
        
        <!-- Topic Search Input -->
        <div class="mb-4">
            <input type="text" id="topic-search" placeholder="Tìm kiếm chủ đề..." class="w-full p-3 bg-gray-800 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-purple-400 transition-colors">
        </div>

        <div id="topicNav" class="mb-4 border-b-2 border-gray-700 sticky top-0 bg-gray-900 py-2 z-10 overflow-x-auto whitespace-nowrap"></div>

        <div id="vocab-list" class="space-y-4">
            <div id="loader" class="text-center p-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-400 mx-auto"></div>
                <p class="mt-4 text-lg font-semibold text-gray-500">hệ thống đang lấy dữ liệu...</p>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykgN9Mf37KxqMZx2XW1mqPJJ3jVunAWVEljUAszFJVwMLxDXJpDHg6cvpdkMHR2v_iKQ/exec';

    // --- GLOBAL STATE ---
    let allWords = [];
    let currentFilter = 'all';
    let selectedTopic = 'all'; // Keep track of the selected topic filter
    let voices = [];
    
    // --- HELPER FUNCTIONS ---
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    // --- CORE FUNCTIONS ---
    function goBack() {
        window.history.back();
    }
    
    async function apiCall(formData, isUpdate = false) {
        Swal.fire({
            title: 'Hệ thống đang xử lý...',
            html: 'Vui lòng đợi trong giây lát...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: formData });
            await loadVocabulary(); 
            const successTitle = isUpdate ? 'Cập nhật thành công!' : 'Thêm thành công!';
            const successHtml = isUpdate ? 'Đã cập nhật từ vựng trong hệ thống.' : 'Đã thêm từ vựng mới vào hệ thống.';
            
            const result = await Swal.fire({
                icon: 'success',
                title: successTitle,
                html: successHtml,
                showConfirmButton: true,
                confirmButtonText: 'Nhập tiếp từ mới',
                showCancelButton: true,
                cancelButtonText: 'Đóng',
                confirmButtonColor: '#8b5cf6',
            });
            if (result.isConfirmed) openForm();
        } catch (error) {
            console.error("API Call Error:", error);
            Swal.fire({
                icon: 'error',
                title: 'Thất bại!',
                html: 'Đã xảy ra lỗi khi gửi dữ liệu. Vui lòng kiểm tra kết nối mạng.<br>Chi tiết: ' + error.message,
            });
        }
    }
        
    async function loadVocabulary() {
        const container = $('#vocab-list');
        const loader = $('#loader');
        const isFirstLoad = allWords.length === 0;

        if (isFirstLoad && loader) {
            loader.style.display = 'block';
            if (container) container.innerHTML = '';
            container.appendChild(loader);
        }

        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            allWords = data.map((word) => {
                const englishWord = word.english || word.English || '';
                return {
                    english: englishWord,
                    type: word.type || word.Type || '',
                    ipa: word.ipa || word.IPA || '',
                    synonym: (word.synonym || word.Synonym) ? String(word.synonym || word.Synonym).split(/,\s*/).map(s => s.trim()) : [],
                    vietnamese: word.vietnamese || word.Vietnamese || '',
                    antonym: (word.antonym || word.Antonym) ? String(word.antonym || word.Antonym).split(/,\s*/).map(a => a.trim()) : [],
                    definition: word.definition || word.Definition || '',
                    example: word.example || word.Example || '',
                    topic: word.topic || word.Topic || 'Chưa phân loại',
                    checked: localStorage.getItem(`vocab_checked_${englishWord}`) === "true",
                    id: word.ID || word.Id || englishWord // IMPORTANT: Using the row number as a unique ID
                };
            });

            displayVocabulary();
        } catch (error) {
            console.error("Fetch error:", error);
            if(container) {
                container.innerHTML = `<div class="text-center p-6 bg-red-900 border-l-4 border-red-500 text-red-300 rounded-lg">
                    <p class="font-bold">Xin lỗi! Hệ thống đang bị lỗi.</p>
                    <p class="text-sm mt-2">Vui lòng kiểm tra lại kết nối mạng.</p>
                </div>`;
            }
        } finally {
            if (loader) loader.style.display = 'none';
        }
    }

    function groupByTopic(words) {
        return words.reduce((grouped, word) => {
            const topic = word.topic;
            (grouped[topic] = grouped[topic] || []).push(word);
            return grouped;
        }, {});
    }

    function setFilter(filter, btn) {
        currentFilter = filter;
        const activeClasses = ['active', 'bg-purple-500', 'text-white'];
        $$('.filter-btn').forEach(b => b.classList.remove(...activeClasses));
        btn.classList.add(...activeClasses);
        displayVocabulary();
    }

    function selectTopic(topic) {
        selectedTopic = topic;
        displayVocabulary();
    }

    function displayVocabulary() {
        const container = $('#vocab-list');
        if (!container) return;
        container.innerHTML = '';

        // --- FILTERING LOGIC ---
        let wordsToDisplay = allWords;

        // 1. Filter by selected topic
        if (selectedTopic !== 'all') {
            wordsToDisplay = wordsToDisplay.filter(word => word.topic === selectedTopic);
        }

        // 2. Filter by main search query (for words)
        const searchQuery = $('#search').value.toLowerCase();
        if (searchQuery) {
            wordsToDisplay = wordsToDisplay.filter(word =>
                word.english.toLowerCase().includes(searchQuery) ||
                word.vietnamese.toLowerCase().includes(searchQuery) ||
                word.antonym.join(' ').toLowerCase().includes(searchQuery) ||
                word.synonym.join(' ').toLowerCase().includes(searchQuery)
            );
        }

        // 3. Filter by status (checked/unchecked)
        if (currentFilter === 'checked') {
            wordsToDisplay = wordsToDisplay.filter(w => w.checked);
        } else if (currentFilter === 'unchecked') {
            wordsToDisplay = wordsToDisplay.filter(w => !w.checked);
        }
        
        // Update the topic navigation bar
        const allAvailableTopics = [...new Set(allWords.map(word => word.topic || 'Chưa phân loại'))];
        updateTopicNav(allAvailableTopics);

        // --- RENDERING LOGIC ---
        const grouped = groupByTopic(wordsToDisplay);

        if (Object.keys(grouped).length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 mt-8">Không tìm thấy từ vựng nào phù hợp.</p>`;
        } else {
            Object.keys(grouped).sort().forEach(topic => {
                const topicHeader = document.createElement('h3');
                topicHeader.textContent = topic;
                topicHeader.className = 'text-2xl font-bold text-purple-400 my-4 pb-2 border-b-2 border-purple-700';
                topicHeader.id = `section-${topic.replace(/\s+/g, '-')}`;
                container.appendChild(topicHeader);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                grouped[topic].forEach(word => grid.appendChild(createWordCard(word)));
                container.appendChild(grid);
            });
        }
        updateStats();
    }
    
    function updateTopicNav(allTopics) {
        const nav = $('#topicNav');
        if (!nav) return;

        const topicSearchQuery = $('#topic-search').value.toLowerCase();
        const filteredTopics = allTopics.filter(topic => topic.toLowerCase().includes(topicSearchQuery));

        nav.innerHTML = ''; // Clear previous buttons

        // Create and append the "All Topics" button
        const allBtn = document.createElement('button');
        allBtn.textContent = 'Tất cả chủ đề';
        allBtn.className = 'nav-button inline-block whitespace-nowrap mr-2 mb-2 px-4 py-2 rounded-full border border-gray-600 bg-gray-800 hover:bg-purple-900 hover:border-purple-400 transition-colors';
        if (selectedTopic === 'all') {
            allBtn.classList.add('bg-purple-500', 'text-white', 'border-purple-600');
        }
        allBtn.onclick = () => selectTopic('all');
        nav.appendChild(allBtn);

        // Create and append buttons for each filtered topic
        filteredTopics.sort().forEach(topic => {
            const button = document.createElement('button');
            button.textContent = topic;
            button.className = 'nav-button inline-block whitespace-nowrap mr-2 mb-2 px-4 py-2 rounded-full border border-gray-600 bg-gray-800 hover:bg-purple-900 hover:border-purple-400 transition-colors';
            if (selectedTopic === topic) {
                button.classList.add('bg-purple-500', 'text-white', 'border-purple-600');
            }
            button.onclick = () => selectTopic(topic);
            nav.appendChild(button);
        });
    }

    function createWordCard(word) {
        const card = document.createElement('div');
        card.className = `card relative p-5 bg-gray-800 shadow-md rounded-xl border border-gray-700 transition-all duration-300`;
        card.id = `card-${String(word.id)}`; // Use the unique ID for the card
        if (word.checked) card.classList.add('bg-opacity-20', 'bg-purple-900');

        card.innerHTML = `
            <div class="flex-1 pr-12">
                <div class="flex items-center mb-1">
                    <span class="word text-xl font-bold text-gray-100">${word.english}</span>
                    <button class="speak-btn ml-2 text-gray-500 hover:text-purple-600" title="Đọc từ">🔊</button>
                    ${word.definition ? `<button class="view-def-btn ml-2 text-gray-500 hover:text-purple-600" title="Hiện định nghĩa">👁️</button>` : ''}
                    <button class="edit-btn ml-2 text-gray-500 hover:text-purple-600" title="Chỉnh sửa từ">✏️</button>
                </div>
                <div class="text-gray-400 text-sm mb-2">
                    ${word.ipa ? `<small>[${word.ipa}]</small>` : ''} 
                    ${word.type ? `<small class="font-semibold uppercase ml-2">(${word.type})</small>` : ''}
                </div>
                <div class="definition-box mt-2 text-sm space-y-1" style="display: none;" id="def-${word.id}">${formatDefinition(word.definition)}</div>
                <span class="vietnamese text-lg text-purple-400 font-medium mt-1">${word.vietnamese}</span>
                ${word.synonym.length ? `<div class="synonym mt-2 text-sm"><strong>Đồng nghĩa:</strong> ${word.synonym.map(s => `<span class="clickable-word text-blue-500 hover:underline cursor-pointer">${s}</span>`).join(', ')}</div>` : ''}
                ${word.antonym.length ? `<div class="antonym mt-1 text-sm"><strong>Trái nghĩa:</strong> ${word.antonym.map(a => `<span class="clickable-word text-red-500 hover:underline cursor-pointer">${a}</span>`).join(', ')}</div>` : ''}
                ${formatExamples(word.example, word)}
            </div>
            <div class="absolute top-4 right-4 flex flex-col items-center">
                <input type="checkbox" class="checkbox w-6 h-6 rounded text-purple-600 focus:ring-purple-500" ${word.checked ? 'checked' : ''} title="Đánh dấu đã học" />
            </div>
        `;
        
        card.querySelector('.speak-btn').addEventListener('click', (e) => { e.stopPropagation(); speak(word.english); });
        card.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openForm(word); });
        
        const viewDefBtn = card.querySelector('.view-def-btn');
        if (viewDefBtn) {
            viewDefBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const defBox = $(`#def-${word.id}`);
                if (defBox) {
                    defBox.style.display = defBox.style.display === 'none' ? 'block' : 'none';
                }
            });
        }

        card.querySelectorAll('.clickable-word').forEach(w => w.addEventListener('click', e => { e.stopPropagation(); scrollAndHighlight(w.textContent); }));
        
        card.querySelector('.checkbox').addEventListener('change', (e) => {
            word.checked = e.target.checked;
            localStorage.setItem(`vocab_checked_${word.english}`, e.target.checked);
            card.classList.toggle('bg-opacity-20', e.target.checked);
            card.classList.toggle('bg-purple-900', e.target.checked);
            updateStats();
            if (currentFilter !== 'all' || selectedTopic !== 'all') {
                setTimeout(() => card.remove(), 300);
            }
        });
        return card;
    }

    const scrollAndHighlight = (text) => {
        // Find the word object first to get its ID
        const wordObject = allWords.find(w => w.english.toLowerCase() === text.toLowerCase());
        if (!wordObject) return;

        const target = $(`#card-${wordObject.id}`);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('highlight-scroll');
            setTimeout(() => target.classList.remove('highlight-scroll'), 2000);
        }
    };

    function formatDefinition(definition) {
        if (!definition) return '';
        return definition.split(/\n|[;；]/).map(line => {
            const parts = line.split(':');
            if (parts.length > 1) return `<div class="mb-1"><strong class="text-gray-300">${parts[0].trim()}</strong>: ${parts.slice(1).join(':').trim()}</div>`;
            return `<div class="mb-1">${line.trim()}</div>`;
        }).join('');
    }

    function formatExamples(exampleText, word) {
        if (!exampleText) return '';
        const regex = new RegExp(`\\b(${word.english})\\b`, 'gi');
        const examples = exampleText.split(/\n|[;；]/).map(e => e.trim()).filter(e => e);
        if(examples.length === 0) return '';
        
        const highlighted = examples.map(e => e.replace(regex, `<span class="text-red-500 font-bold">$1</span>`));
        const first = highlighted[0];
        const rest = highlighted.slice(1).map(e => `<div class='extra-example mt-1'>${e}</div>`).join('');
        const seeMoreBtn = highlighted.length > 1 ? `<button class="text-blue-500 text-sm ml-2 hover:underline" onclick="toggleExamples(this, event)">Xem thêm</button>` : '';

        return `<div class="info mt-2 text-sm text-gray-400"><strong>Ví dụ:</strong><div class="example-line italic">${first} ${seeMoreBtn}</div><div class="hidden">${rest}</div></div>`;
    }

    function toggleExamples(button, event) {
        event.stopPropagation();
        const container = button.parentElement.nextElementSibling;
        const isHidden = container.classList.contains('hidden');
        container.classList.toggle('hidden', !isHidden);
        button.textContent = isHidden ? 'Ẩn bớt' : 'Xem thêm';
    }

    function updateStats() {
        const statsEl = $('#stats');
        if (!statsEl) return;
        const total = allWords.length;
        const checked = allWords.filter(w => w.checked).length;
        statsEl.innerHTML = `Tổng: <span class="font-bold">${total}</span> | Đã học: <span class="font-bold text-green-600">${checked}</span> | Chưa học: <span class="font-bold text-red-600">${total - checked}</span>`;
    }
    
    function loadVoices() {
        voices = speechSynthesis.getVoices();
        if (voices.length === 0) {
            speechSynthesis.onvoiceschanged = () => { voices = speechSynthesis.getVoices(); };
        }
    }

    function speak(text) {
        if (speechSynthesis.speaking) speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        const voice = voices.find(v => v.name === 'Google US English') || voices.find(v => v.lang.startsWith('en-'));
        if (voice) utterance.voice = voice;
        speechSynthesis.speak(utterance);
    }

    function openForm(wordToEdit = null) {
        const isUpdate = wordToEdit !== null;
        const uniqueTopics = [...new Set(allWords.map(word => word.topic).filter(topic => topic && topic !== 'Chưa phân loại'))].sort();

        Swal.fire({
            title: `<h2 class="text-2xl font-bold">${isUpdate ? 'Chỉnh sửa từ vựng' : 'Thêm từ vựng mới'}</h2>`,
            html: `
                <div class="text-left">
                    <div class="py-4 border-b border-gray-700">
                        <h3 class="text-lg font-semibold text-purple-400 mb-4">Thông tin cơ bản</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="swal-eng" class="block mb-1 font-medium text-sm">Tiếng Anh <span class="text-red-500">*</span></label>
                                <input id="swal-eng" class="swal2-input" placeholder="Nhập từ tiếng anh..." value="${isUpdate ? wordToEdit.english : ''}" ${isUpdate ? 'readonly' : ''}>
                                <div id="swal-eng-exists-warning" class="text-red-500 text-xs mt-1 h-4"></div>
                            </div>
                            <div>
                                <label for="swal-ipa" class="block mb-1 font-medium text-sm">IPA <span class="text-red-500">*</span></label>
                                <input id="swal-ipa" class="swal2-input" placeholder="Nhập phiên âm IPA..." value="${isUpdate ? wordToEdit.ipa : ''}">
                            </div>
                            <div>
                                <label for="swal-type" class="block mb-1 font-medium text-sm">Loại từ</label>
                                <input id="swal-type" class="swal2-input" placeholder="e.g., noun, verb..." value="${isUpdate ? wordToEdit.type : ''}">
                            </div>
                            <div>
                                <label for="swal-topic-select" class="block mb-1 font-medium text-sm">Chủ đề</label>
                                <select id="swal-topic-select" class="swal2-select p-3">
                                    <option value="Chưa phân loại">Chưa phân loại</option>
                                    ${uniqueTopics.map(topic => `<option value="${topic}" ${isUpdate && wordToEdit.topic === topic ? 'selected' : ''}>${topic}</option>`).join('')}
                                    <option value="--new-topic--">--- Nhập chủ đề mới ---</option>
                                </select>
                                <input id="swal-topic-new" class="swal2-input mt-2" placeholder="Nhập tên chủ đề mới..." style="display: none;">
                            </div>
                        </div>
                    </div>
                    <div class="py-4 border-b border-gray-700">
                        <h3 class="text-lg font-semibold text-purple-400 mb-4">Nghĩa & Từ liên quan</h3>
                        <div>
                            <label for="swal-viet" class="block mb-1 font-medium text-sm">Tiếng Việt <span class="text-red-500">*</span></label>
                            <input id="swal-viet" class="swal2-input" placeholder="Nhập nghĩa tiếng Việt..." value="${isUpdate ? wordToEdit.vietnamese : ''}">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="swal-syn" class="block mb-1 font-medium text-sm">Đồng nghĩa</label>
                                <textarea id="swal-syn" class="swal2-textarea h-24" placeholder="Các từ cách nhau bằng dấu phẩy...">${isUpdate ? wordToEdit.synonym.join(', ') : ''}</textarea>
                            </div>
                            <div>
                                <label for="swal-ant" class="block mb-1 font-medium text-sm">Trái nghĩa</label>
                                <textarea id="swal-ant" class="swal2-textarea h-24" placeholder="Các từ cách nhau bằng dấu phẩy...">${isUpdate ? wordToEdit.antonym.join(', ') : ''}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <h3 class="text-lg font-semibold text-purple-400 mb-4">Chi tiết & Ví dụ</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="swal-def" class="block mb-1 font-medium text-sm">Định nghĩa</label>
                                <textarea id="swal-def" class="swal2-textarea h-28" placeholder="Định nghĩa chi tiết bằng tiếng Anh...">${isUpdate ? wordToEdit.definition : ''}</textarea>
                            </div>
                            <div>
                                <label for="swal-ex" class="block mb-1 font-medium text-sm">Ví dụ</label>
                                <textarea id="swal-ex" class="swal2-textarea h-28" placeholder="Các câu ví dụ, mỗi câu một dòng...">${isUpdate ? wordToEdit.example : ''}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            customClass: { 
                popup: 'w-[95%] max-w-3xl rounded-xl',
                htmlContainer: 'max-h-[65vh] overflow-y-auto px-4 sm:px-6 pb-6',
                title: 'pt-6 px-4 sm:px-6',
                select: 'swal2-input'
            },
            showConfirmButton: true,
            showCancelButton: true,
            confirmButtonText: isUpdate ? 'Cập nhật từ' : 'Thêm từ',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#8b5cf6',
            focusConfirm: false,
            allowOutsideClick: false,
            didOpen: () => {
                const engInput = $('#swal-eng');
                const warningDiv = $('#swal-eng-exists-warning');
                const topicSelect = $('#swal-topic-select');
                const newTopicInput = $('#swal-topic-new');

                if (engInput && !isUpdate) { // Only add listener if it's a new word
                    engInput.focus(); 
                    engInput.addEventListener('blur', function() {
                        const engWord = this.value.trim().toLowerCase();
                        if (!engWord) {
                            if(warningDiv) warningDiv.textContent = '';
                            return;
                        }
                        const existingWord = allWords.find(word => word.english.toLowerCase() === engWord);
                        if(existingWord) {
                           warningDiv.textContent = '(!) Từ này đã tồn tại.';
                           Swal.fire({
                               title: 'Từ đã tồn tại',
                               text: `"${existingWord.english}" đã có trong sổ tay. Bạn có muốn chỉnh sửa nó không?`,
                               icon: 'question',
                               showCancelButton: true,
                               confirmButtonColor: '#8b5cf6',
                               cancelButtonColor: '#d33',
                               confirmButtonText: 'Có, chỉnh sửa!',
                               cancelButtonText: 'Không'
                           }).then((result) => {
                               if (result.isConfirmed) {
                                   openForm(existingWord); // Re-open the form in edit mode
                               }
                           });
                        } else {
                           if(warningDiv) warningDiv.textContent = '';
                        }
                    });
                }
                
                if (topicSelect && newTopicInput) {
                    topicSelect.addEventListener('change', function() {
                        if (this.value === '--new-topic--') {
                            newTopicInput.style.display = 'block';
                            newTopicInput.focus();
                        } else {
                            newTopicInput.style.display = 'none';
                        }
                    });
                }
            },
            preConfirm: () => {
                const getVal = (id) => $(`#${id}`).value.trim();
                const eng = getVal('swal-eng');
                const ipa = getVal('swal-ipa');
                const viet = getVal('swal-viet');

                if (!eng || !ipa || !viet) {
                    Swal.showValidationMessage(`Vui lòng điền đủ các trường bắt buộc (*).`);
                    return false;
                }
                
                if (!isUpdate) {
                    const englishRegex = /^[a-zA-Z0-9\s-']+$/; 
                    if (!englishRegex.test(eng)) {
                        Swal.showValidationMessage(`Ô Tiếng Anh không được chứa ký tự có dấu hoặc ký tự đặc biệt.`);
                        return false; 
                    }

                    const exists = allWords.some(word => word.english.toLowerCase() === eng.toLowerCase());
                    if (exists) {
                        Swal.showValidationMessage(`Từ "${eng}" đã tồn tại. Vui lòng nhập một từ khác.`);
                        return false;
                    }
                }

                let topic = getVal('swal-topic-select');
                if (topic === '--new-topic--') {
                    topic = getVal('swal-topic-new') || 'Chưa phân loại';
                }

                const formData = new FormData();
                formData.append("action", isUpdate ? "update" : "add");
                if (isUpdate) {
                    formData.append("id", wordToEdit.id); // Send the row ID for update
                }
                formData.append("english", eng);
                formData.append("ipa", ipa);
                formData.append("vietnamese", viet);
                formData.append("type", getVal('swal-type'));
                formData.append("definition", getVal('swal-def'));
                formData.append("synonym", getVal('swal-syn'));
                formData.append("antonym", getVal('swal-ant'));
                formData.append("example", getVal('swal-ex'));
                formData.append("topic", topic);
                return formData;
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                apiCall(result.value, isUpdate);
            }
        });
    }
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Dark mode is now set by default in the HTML tag with class="dark"
        // All theme-switching logic has been removed.
        
        $('#search')?.addEventListener('input', displayVocabulary);
        $('#add-word-btn')?.addEventListener('click', () => openForm());
        $('#topic-search')?.addEventListener('input', () => {
            const allAvailableTopics = [...new Set(allWords.map(word => word.topic || 'Chưa phân loại'))];
            updateTopicNav(allAvailableTopics);
        });
        
        loadVoices();
        loadVocabulary();
    });
</script>
</body>
</html>
